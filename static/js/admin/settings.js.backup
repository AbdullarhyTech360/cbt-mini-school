// Settings Page JavaScript - Term Management and Form Handling

document.addEventListener("DOMContentLoaded", function () {
  // Term Management Elements
  const addTermBtn = document.getElementById("add-term-btn");
  const termFormContainer = document.getElementById("term-form-container");
  const termForm = document.getElementById("term-form");
  const closeFormBtn = document.getElementById("close-form-btn");
  const cancelFormBtn = document.getElementById("cancel-form-btn");
  const termsList = document.getElementById("terms-list");
  const formTitle = document.getElementById("form-title");
  const submitBtnText = document.getElementById("submit-btn-text");
  const schoolLogoInput = document.getElementById("school-logo");

  // Term data storage
  let terms = [];

  // Initialize
  loadTerms();
  setupEventListeners();

  // Setup Event Listeners
  function setupEventListeners() {
    // Term form events
    if (addTermBtn) {
      addTermBtn.addEventListener("click", showAddTermForm);
    }

    if (closeFormBtn) {
      closeFormBtn.addEventListener("click", hideTermForm);
    }

    if (cancelFormBtn) {
      cancelFormBtn.addEventListener("click", hideTermForm);
    }

    if (termForm) {
      termForm.addEventListener("submit", handleTermSubmit);
    }

    // Logo preview
    if (schoolLogoInput) {
      schoolLogoInput.addEventListener("change", handleLogoPreview);
    }

    // Term number auto-fills term name
    const termNumberSelect = document.getElementById("term-number");
    if (termNumberSelect) {
      termNumberSelect.addEventListener("change", function () {
        const termNameInput = document.getElementById("term-name");
        const termNames = {
          1: "First Term",
          2: "Second Term",
          3: "Third Term",
        };
        if (termNameInput && this.value) {
          termNameInput.value = termNames[this.value] || "";
        }
      });
    }

    // Details toggle animation
    const detailsElements = document.querySelectorAll("details");
    detailsElements.forEach((details) => {
      details.addEventListener("toggle", function () {
        const icon = this.querySelector(
          "summary span.material-symbols-outlined:last-child",
        );
        if (icon) {
          if (this.open) {
            icon.style.transform = "rotate(180deg)";
          } else {
            icon.style.transform = "rotate(0deg)";
          }
        }
      });
    });
  }

  // Show Add Term Form
  function showAddTermForm() {
    formTitle.textContent = "Add New Term";
    submitBtnText.textContent = "Save Term";
    termForm.reset();
    document.getElementById("term-id").value = "";
    document.getElementById("is-active").checked = true;
    document.getElementById("is-current").checked = false;
    termFormContainer.classList.remove("hidden");
    termFormContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  // Hide Term Form
  function hideTermForm() {
    termFormContainer.classList.add("hidden");
    termForm.reset();
  }

  // Show Edit Term Form
  function showEditTermForm(term) {
    formTitle.textContent = "Edit Term";
    submitBtnText.textContent = "Update Term";

    document.getElementById("term-id").value = term.term_id;
    document.getElementById("academic-session").value = term.academic_session;
    document.getElementById("term-number").value = term.term_number;
    document.getElementById("term-name").value = term.term_name;
    document.getElementById("start-date").value = term.start_date;
    document.getElementById("end-date").value = term.end_date;
    document.getElementById("is-active").checked = term.is_active;
    document.getElementById("is-current").checked = term.is_current;

    termFormContainer.classList.remove("hidden");
    termFormContainer.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  // Handle Term Form Submit
  async function handleTermSubmit(e) {
    e.preventDefault();

    const termId = document.getElementById("term-id").value;
    const formData = {
      term_name: document.getElementById("term-name").value,
      term_number: parseInt(document.getElementById("term-number").value),
      academic_session: document.getElementById("academic-session").value,
      start_date: document.getElementById("start-date").value,
      end_date: document.getElementById("end-date").value,
      is_active: document.getElementById("is-active").checked,
      is_current: document.getElementById("is-current").checked,
    };

    // Validate dates
    if (new Date(formData.end_date) <= new Date(formData.start_date)) {
      showNotification("End date must be after start date", "error");
      return;
    }

    try {
      let response;
      if (termId) {
        // Update existing term
        response = await fetch(`/admin/settings/terms/${termId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });
      } else {
        // Create new term
        response = await fetch("/admin/settings/terms", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(formData),
        });
      }

      const result = await response.json();

      if (result.success) {
        showNotification(result.message, "success");
        hideTermForm();
        await loadTerms();
      } else {
        alert(result.message || "Operation failed");
        showNotification(result.message || "Operation failed", "error");
      }
    } catch (error) {
      console.error("Error saving term:", error);
      showNotification("Failed to save term. Please try again.", "error");
    }
  }

  // Delete Term
  async function deleteTerm(termId) {
    if (confirm("Are you sure you want to delete this term?")) {
      try {
        const response = await fetch(`/admin/api/terms/${termId}`, {
          method: "DELETE",
        });

        const result = await response.json();

        if (result.success) {
          showNotification(result.message, "success");
          await loadTerms();
        } else {
          showNotification(result.message || "Failed to delete term", "error");
        }
      } catch (error) {
        console.error("Error deleting term:", error);
        showNotification("Failed to delete term. Please try again.", "error");
      }
    }
  }

  // Load Terms from Backend
  async function loadTerms() {
    try {
      const response = await fetch("/admin/settings/terms");
      const result = await response.json();
      console.log(result.terms);

      if (result.success && result.terms.length > 0) {
        terms = result.terms;
        renderTermsList();
      } else {
        showNotification("Failed to load terms", "error");
      }
    } catch (error) {
      console.error("Error loading terms:", error);
      showNotification(
        "Failed to load terms. Please refresh the page.",
        "error",
      );
    }
  }

  // Render Terms List
  function renderTermsList() {
    const emptyState = document.getElementById("empty-state");

    if (terms.length === 0) {
      termsList.innerHTML = "";
      if (emptyState) {
        emptyState.classList.remove("hidden");
        termsList.appendChild(emptyState);
      }
      updateStats();
      return;
    }

    if (emptyState) {
      emptyState.classList.add("hidden");
    }

    // Sort terms by session and term number
    const sortedTerms = [...terms].sort((a, b) => {
      if (a.academic_session !== b.academic_session) {
        return b.academic_session.localeCompare(a.academic_session);
      }
      return a.term_number - b.term_number;
    });

    termsList.innerHTML = sortedTerms
      .map((term) => createTermCard(term))
      .join("");

    // Attach event listeners to action buttons
    termsList.querySelectorAll(".edit-term-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        const termId = this.dataset.termId;
        const term = terms.find((t) => t.term_id === termId);
        if (term) showEditTermForm(term);
      });
    });

    termsList.querySelectorAll(".delete-term-btn").forEach((btn) => {
      btn.addEventListener("click", function () {
        const termId = this.dataset.termId;
        deleteTerm(termId);
      });
    });

    updateStats();
  }

  // Create Term Card HTML
  function createTermCard(term) {
    const termNames = {
      1: "First Term",
      2: "Second Term",
      3: "Third Term",
    };

    const startDate = new Date(term.start_date).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });
    const endDate = new Date(term.end_date).toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: "numeric",
    });

    return `
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600 hover:shadow-md transition-all">
                <div class="flex-1">
                    <div class="flex items-center gap-3 flex-wrap">
                        <div class="flex items-center gap-2 text-sm font-semibold text-gray-900 dark:text-white">
                            <span class="material-symbols-outlined text-primary text-lg">event</span>
                            <span>${term.term_name || termNames[term.term_number]}</span>
                        </div>
                        ${term.is_current ? '<span class="px-2 py-1 text-xs font-medium bg-primary/20 text-primary dark:bg-primary/30 dark:text-white rounded-full">Current</span>' : ""}
                        ${term.is_active ? '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 rounded-full">Active</span>' : '<span class="px-2 py-1 text-xs font-medium bg-gray-200 text-gray-600 dark:bg-gray-600 dark:text-gray-300 rounded-full">Inactive</span>'}
                    </div>
                    <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-600 dark:text-gray-400">
                        <span class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">school</span>
                            Session: ${term.academic_session}
                        </span>
                        <span class="flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">calendar_month</span>
                            ${startDate} - ${endDate}
                        </span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button
                        class="edit-term-btn p-2 text-blue-600 hover:bg-blue-50 dark:text-blue-400 dark:hover:bg-blue-900/20 rounded-lg transition-all"
                        title="Edit Term"
                        data-term-id="${term.term_id}">
                        <span class="material-symbols-outlined text-sm">edit</span>
                    </button>
                    <button
                        class="delete-term-btn p-2 text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 rounded-lg transition-all"
                        title="Delete Term"
                        data-term-id="${term.term_id}">
                        <span class="material-symbols-outlined text-sm">delete</span>
                    </button>
                </div>
            </div>
        `;
  }

  // Update Statistics
  function updateStats() {
    const totalTerms = terms.length;
    const currentTerm = terms.find((t) => t.is_current);
    const activeSessions = [...new Set(terms.map((t) => t.academic_session))];

    const statsContainer = document.querySelector(
      ".grid.grid-cols-1.sm\\:grid-cols-3",
    );
    if (statsContainer) {
      const stats = statsContainer.querySelectorAll("div");
      if (stats[0]) {
        stats[0].querySelector(".text-2xl").textContent = totalTerms;
      }
      if (stats[1]) {
        stats[1].querySelector(".text-2xl").textContent = currentTerm
          ? "1"
          : "0";
      }
      if (stats[2]) {
        const activeSession = currentTerm
          ? currentTerm.academic_session
          : activeSessions[0] || "N/A";
        stats[2].querySelector(".text-2xl").textContent = activeSession;
      }
    }
  }

  // Handle Logo Preview
  function handleLogoPreview(e) {
    const file = e.target.files[0];
    if (file) {
      // Check file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        showNotification("Image size must be less than 2MB", "error");
        e.target.value = "";
        return;
      }

      // Check file type
      if (!file.type.startsWith("image/")) {
        showNotification("Please select a valid image file", "error");
        e.target.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function (event) {
        logoPreview.innerHTML = `<img src="${event.target.result}" alt="School Logo" class="w-full h-full object-cover rounded-lg">`;
      };
      reader.readAsDataURL(file);
    }
  }

  // Show Notification
  function showNotification(message, type = "info") {
    // Create notification element
    const notification = document.createElement("div");
    notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${
      type === "success"
        ? "bg-green-500 text-white"
        : type === "error"
          ? "bg-red-500 text-white"
          : "bg-blue-500 text-white"
    }`;
    notification.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-sm">${
                  type === "success"
                    ? "check_circle"
                    : type === "error"
                      ? "error"
                      : "info"
                }</span>
                <span>${message}</span>
            </div>
        `;

    document.body.appendChild(notification);

    // Animate in
    setTimeout(() => {
      notification.style.transform = "translateX(0)";
    }, 10);

    // Remove after 3 seconds
    setTimeout(() => {
      notification.style.transform = "translateX(400px)";
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 300);
    }, 3000);
  }

  // ===========================
  // SIMPLE SECTION MANAGEMENT
  // ===========================

  const sectionsContainer = document.getElementById("sections-container");
  const addSectionRowBtn = document.getElementById("add-section-row-btn");
  const saveSectionsBtn = document.getElementById("save-sections-btn");
  const existingSectionsList = document.getElementById(
    "existing-sections-list",
  );

  // Load existing sections on page load
  if (existingSectionsList) {
    loadExistingSections();
  }

  // Add another section input row
  if (addSectionRowBtn) {
    addSectionRowBtn.addEventListener("click", function () {
      const newRow = document.createElement("div");
      newRow.className = "section-input-row flex items-end gap-3";
      newRow.innerHTML = `
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Section Name</label>
          <input
            class="section-name w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
            type="text"
            placeholder="e.g., Nursery, Primary, Secondary"
            required
          />
        </div>
        <div class="flex-1">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Abbreviation</label>
          <input
            class="section-abbr w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
            type="text"
            placeholder="e.g., NUR, PRI, SEC"
            required
          />
        </div>
        <button
          type="button"
          class="remove-section-btn px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all duration-200"
          title="Remove"
        >
          <span class="material-symbols-outlined text-sm">close</span>
        </button>
      `;

      sectionsContainer.appendChild(newRow);

      // Add event listener to remove button
      newRow
        .querySelector(".remove-section-btn")
        .addEventListener("click", function () {
          newRow.remove();
        });
    });
  }

  // Save sections
  if (saveSectionsBtn) {
    saveSectionsBtn.addEventListener("click", async function () {
      const rows = sectionsContainer.querySelectorAll(".section-input-row");
      const sectionsToSave = [];

      // Collect data from all rows
      rows.forEach((row) => {
        const nameInput = row.querySelector(".section-name");
        const abbrInput = row.querySelector(".section-abbr");

        if (nameInput.value.trim() && abbrInput.value.trim()) {
          sectionsToSave.push({
            name: nameInput.value.trim(),
            abbreviation: abbrInput.value.trim().toUpperCase(),
          });
        }
      });

      if (sectionsToSave.length === 0) {
        showNotification("Please enter at least one section", "error");
        return;
      }

      // Save each section
      let successCount = 0;
      let errorCount = 0;

      for (const section of sectionsToSave) {
        try {
          const response = await fetch("/admin/settings/sections", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(section),
          });

          const result = await response.json();

          if (result.success) {
            successCount++;
          } else {
            errorCount++;
            console.error("Error saving section:", result.message);
          }
        } catch (error) {
          errorCount++;
          console.error("Error saving section:", error);
        }
      }

      // Show results
      if (successCount > 0) {
        showNotification(
          `Successfully saved ${successCount} section(s)`,
          "success",
        );

        // Clear the form
        sectionsContainer.innerHTML = `
          <div class="section-input-row flex items-end gap-3">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Section Name</label>
              <input
                class="section-name w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
                type="text"
                placeholder="e.g., Nursery, Primary, Secondary"
                required
              />
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Abbreviation</label>
              <input
                class="section-abbr w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition"
                type="text"
                placeholder="e.g., NUR, PRI, SEC"
                required
              />
            </div>
            <button
              type="button"
              class="remove-section-btn hidden px-3 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-all duration-200"
              title="Remove"
            >
              <span class="material-symbols-outlined text-sm">close</span>
            </button>
          </div>
        `;

        // Reload existing sections
        loadExistingSections();
      }

      if (errorCount > 0) {
        showNotification(
          `Failed to save ${errorCount} section(s). Check console for details.`,
          "error",
        );
      }
    });
  }

  // Load and display existing sections
  async function loadExistingSections() {
    if (!existingSectionsList) return;

    try {
      const response = await fetch("/admin/settings/sections");
      const result = await response.json();
      console.log(result);
      if (result.success) {
        const sections = result.sections;
        console.log(sections);
        if (sections.length === 0) {
          existingSectionsList.innerHTML = `
            <p class="text-sm text-gray-500 dark:text-gray-400 italic">No sections added yet</p>
          `;
          return;
        }

        existingSectionsList.innerHTML = sections
          .map(
            (section) => `
          <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border border-gray-200 dark:border-gray-600">
            <div>
              <span class="font-medium text-gray-900 dark:text-white">${section.name}</span>
              <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">(${section.abbreviation})</span>
            </div>
            <button
              class="delete-section-btn px-3 py-1 text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-red-900/20 rounded-lg transition-all"
              data-section-id="${section.section_id}"
              title="Delete section"
            >
              Delete
            </button>
          </div>
        `,
          )
          .join("");

        // Add delete functionality
        existingSectionsList
          .querySelectorAll(".delete-section-btn")
          .forEach((btn) => {
            btn.addEventListener("click", async function () {
              const sectionId = this.dataset.sectionId;

              if (!confirm("Are you sure you want to delete this section?")) {
                return;
              }

              try {
                const response = await fetch(
                  `/admin/api/sections/${sectionId}`,
                  {
                    method: "DELETE",
                  },
                );

                const result = await response.json();

                if (result.success) {
                  showNotification(result.message, "success");
                  loadExistingSections();
                } else {
                  showNotification(
                    result.message || "Failed to delete",
                    "error",
                  );
                }
              } catch (error) {
                console.error("Error deleting section:", error);
                showNotification("Failed to delete section", "error");
              }
            });
          });
      }
    } catch (error) {
      console.error("Error loading sections:", error);
    }
  }

  // Save Settings (School Information)
  const saveButton = document.querySelector(
    'button[type="button"]:last-of-type',
  );
  if (saveButton && saveButton.textContent.includes("Save Changes")) {
    saveButton.addEventListener("click", function () {
      // Collect all form data
      const schoolData = {
        school_name: document.getElementById("school-name")?.value,
        school_code: document.getElementById("school-code")?.value,
        motto: document.getElementById("school-motto")?.value,
        address: document.getElementById("school-address")?.value,
        phone: document.getElementById("school-phone")?.value,
        email: document.getElementById("school-contact")?.value,
        website: document.getElementById("school-website")?.value,
        principal_name: document.getElementById("principal-name")?.value,
        established_date: document.getElementById("established-date")?.value,
      };

      // TODO: Send to backend
      console.log("Saving school data:", schoolData);
      showNotification("Settings saved successfully", "success");

      // Handle file upload separately if logo was changed
      const logoFile = document.getElementById("school-logo")?.files[0];
      if (logoFile) {
        // TODO: Upload logo to backend
        console.log("Uploading logo:", logoFile);
      }
    });
  }

  // ===============================
  // })
  // SCHOOL INFO
  // ===============================


  const logoPreview = document.getElementById("logo-preview");
  const saveBtn = document.getElementById("save-school-info-btn");

  saveBtn.addEventListener("click", async () => {
    try {
      const response = await fetch("/api/schools", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          school_name: document.getElementById("school-name")?.value,
          school_code: document.getElementById("school-code")?.value,
          motto: document.getElementById("school-motto")?.value,
          address: document.getElementById("school-address")?.value,
          phone: document.getElementById("school-phone")?.value,
          email: document.getElementById("school-contact")?.value,
          logo: document.getElementById("school-logo")?.files[0],
          website: document.getElementById("school-website")?.value,
          principal_name: document.getElementById("principal-name")?.value,
          established_date: document.getElementById("established-date")?.value,
        }),
      });

      if(!schoolName || !motto || !address || !phone || !email || !website || !principalName || !establishedDate) {
        throw new Error("Please fill in all required fields");
      }

      if (!response.ok) {
        throw new Error("Failed to save school data");
      }

      showNotification("Settings saved successfully", "success");
    } catch (error) {
      showNotification(error.message, "error");
    }
  })};
