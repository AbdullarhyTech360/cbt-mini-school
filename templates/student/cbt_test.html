<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>{{ exam.subject.subject_name }} - CBT Exam</title>
    <link href="{{ url_for('static', filename='dist/output.css') }}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script src="{{ url_for('static', filename='js/components/modal.js') }}"></script>
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                ready: () => {
                    console.log('MathJax is loaded and ready');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <!-- Local MathJax -->
    <script src="{{ url_for('static', filename='dist/mathjax/tex-mml-chtml.js') }}" id="MathJax-script"></script>
    
    <script>
        // Dark mode management
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('darkMode', isDark);
            
            // Update icon
            const icon = document.getElementById('dark-mode-icon');
            if (icon) {
                icon.textContent = isDark ? 'light_mode' : 'dark_mode';
            }
        }
        
        // Load saved preference
        const savedDarkMode = localStorage.getItem('darkMode');
        if (savedDarkMode === 'false') {
            document.documentElement.classList.remove('dark');
        } else if (savedDarkMode === null) {
            // Default to system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.classList.remove('dark');
            }
        }
    </script>
    
    <style>
        * { font-family: 'Inter', sans-serif; }
        
        body { 
            background: #f1f5f9;
            transition: background-color 0.3s ease;
        }
        
        .dark body { 
            background: #0f172a;
        }
        
        .question-nav-btn {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .question-nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .dark .question-nav-btn:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .question-nav-btn.current {
            background: #3b82f6;
            color: white;
            font-weight: bold;
        }
        
        .question-nav-btn.answered {
            background: #10b981;
            color: white;
        }
        
        .question-nav-btn.unanswered {
            background: white;
            border: 2px solid #e2e8f0;
            color: #64748b;
        }
        
        .dark .question-nav-btn.unanswered {
            background: #1e293b;
            border-color: #334155;
            color: #94a3b8;
        }
        
        .option-label {
            transition: all 0.2s ease;
            cursor: pointer;
            background: white;
        }
        
        .dark .option-label {
            background: #1e293b;
        }
        
        .option-label:hover {
            border-color: #3b82f6;
            background: #dbeafe;
            transform: translateX(2px);
        }
        
        .dark .option-label:hover {
            border-color: #60a5fa;
            background: #1e3a8a;
        }
        
        .option-label.selected {
            background: #3b82f6 !important;
            border-color: #2563eb !important;
            color: white;
        }
        
        .dark .option-label.selected {
            background: #2563eb !important;
            border-color: #3b82f6 !important;
        }
        
        /* Ensure good contrast in both modes */
        .text-gray-900 {
            color: #111827;
        }
        
        .dark .text-gray-900 {
            color: #f9fafb;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .dark .text-gray-700 {
            color: #d1d5db;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .dark .text-gray-600 {
            color: #9ca3af;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Top Header -->
    <div class="bg-white dark:bg-slate-800 border-b border-gray-200 dark:border-slate-700 shadow-sm sticky top-0 z-50 transition-colors">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <!-- Top Row -->
            <div class="flex items-center justify-between mb-2">
                <!-- Left: Student -->
                <div class="flex items-center gap-3">
                    {% if current_user.image %}
                    <img src="{{ current_user.image }}" alt="{{ current_user.full_name() }}" class="w-10 h-10 rounded-full border-2 border-blue-500">
                    {% else %}
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold shadow">
                        {{ current_user.first_name[0].upper() }}{{ current_user.last_name[0].upper() }}
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ current_user.full_name() }}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">{% if current_user.class_room %}{{ current_user.class_room.class_room_name }}{% endif %}</p>
                    </div>
                </div>
                
                <!-- Center: Exam -->
                <div class="hidden md:block text-center">
                    <p class="text-base font-bold text-gray-900 dark:text-white">{{ exam.subject.subject_name }}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ exam.exam_type }} • {% if exam.invigilator %}{{ exam.invigilator.full_name() }}{% else %}System Monitored{% endif %}</p>
                </div>
                
                <!-- Right: Timer & Dark Mode -->
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg border border-blue-200 dark:border-blue-800">
                        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">timer</span>
                        <div>
                            <p class="text-xs text-gray-600 dark:text-gray-400">Time Left</p>
                            <p id="timer" class="text-lg font-bold text-blue-600 dark:text-blue-400">--:--</p>
                        </div>
                    </div>
                    
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-lg bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 flex items-center justify-center transition-colors" title="Toggle dark mode">
                        <span id="dark-mode-icon" class="material-symbols-outlined text-gray-700 dark:text-gray-200">light_mode</span>
                    </button>
                </div>
            </div>
            
            <!-- Bottom Row: School Info -->
            <div class="flex items-center justify-between text-xs text-gray-600 dark:text-gray-400 pt-2 border-t border-gray-100 dark:border-slate-700">
                <div class="flex items-center gap-4">
                    <span class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-sm">school</span>
                        {% if exam.class_room and exam.class_room.school %}{{ exam.class_room.school.school_name }}{% else %}Greenwood High School{% endif %}
                    </span>
                    {% if exam.school_term %}
                    <span>{{ exam.school_term.academic_session }} • {{ exam.school_term.term_name }}</span>
                    {% endif %}
                </div>
                <div class="hidden md:flex items-center gap-4">
                    <span>Duration: {{ (exam.duration.seconds // 60) if exam.duration else 30 }} min</span>
                    <span>Max Score: {{ exam.max_score }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Question Content (2/3 width) -->
            <div class="lg:col-span-2">
                <!-- Progress -->
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-4 mb-4 transition-colors">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Question <span id="current-question">1</span> of <span id="total-questions">0</span></span>
                        <span class="text-sm text-gray-600 dark:text-gray-400"><span id="answered-count">0</span> answered</span>
                    </div>
                    <div class="h-2 bg-gray-200 dark:bg-slate-700 rounded-full">
                        <div id="progress-bar" class="h-full bg-blue-500 rounded-full transition-all" style="width: 0%;"></div>
                    </div>
                </div>
                
                <!-- Question -->
                <div id="question-container" class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-6 transition-colors">
                    <noscript>
                        <div class="bg-red-100 dark:bg-red-900/30 border-2 border-red-500 rounded-lg p-6 text-center">
                            <p class="text-red-700 dark:text-red-300 font-bold text-lg mb-2">JavaScript Required</p>
                            <p class="text-red-600 dark:text-red-400">This exam requires JavaScript to be enabled in your browser. Please enable JavaScript and refresh the page.</p>
                        </div>
                    </noscript>
                    <div id="loading-message" class="text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-200 dark:border-blue-900 border-t-blue-600 dark:border-t-blue-400 mb-4"></div>
                        <p class="text-gray-600 dark:text-gray-400">Loading questions...</p>
                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-4">If this takes too long, try refreshing the page (F5)</p>
                    </div>
                    
                    <div id="question-content" class="hidden">
                        <div class="mb-6">
                            <span class="px-3 py-1 bg-blue-500 text-white text-sm font-semibold rounded-full shadow">
                                Question <span id="question-number">1</span>
                            </span>
                            <div id="question-text" class="text-lg text-gray-900 dark:text-white mt-4 mb-6"></div>
                        </div>
                        
                        <div id="answer-options" class="space-y-3 mb-6"></div>
                        
                        <div class="flex items-center justify-between pt-6 border-t border-gray-200 dark:border-slate-700">
                            <button id="prev-question-btn" class="px-6 py-3 bg-gray-100 dark:bg-slate-700 hover:bg-gray-200 dark:hover:bg-slate-600 text-gray-700 dark:text-gray-200 font-semibold rounded-lg transition-colors">
                                ← Previous (P)
                            </button>
                            <button id="submit-quiz-btn" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors shadow">
                                Submit Exam
                            </button>
                            <button id="next-question-btn" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors shadow">
                                Next (N) →
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: Question Navigator (1/3 width) -->
            <div class="lg:col-span-1">
                <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm p-4 sticky top-24 transition-colors">
                    <h3 class="text-sm font-bold text-gray-900 dark:text-white mb-3">Question Navigator</h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">Click any number to jump to that question</p>
                    
                    <!-- GRID OF QUESTION BUTTONS -->
                    <div id="question-navigation" class="grid grid-cols-5 gap-2 mb-4">
                        <!-- Buttons will be inserted here by JavaScript -->
                        <!-- Example: 5 columns, multiple rows -->
                    </div>
                    
                    <!-- Legend -->
                    <div class="pt-4 border-t border-gray-200 dark:border-slate-700 space-y-2 text-xs">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded bg-blue-500 flex items-center justify-center text-white font-bold shadow">1</div>
                            <span class="text-gray-600 dark:text-gray-400">Current</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded bg-green-500 flex items-center justify-center text-white font-bold shadow">2</div>
                            <span class="text-gray-600 dark:text-gray-400">Answered</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded border-2 border-gray-300 dark:border-slate-600 bg-white dark:bg-slate-700 flex items-center justify-center text-gray-600 dark:text-gray-400 font-bold">3</div>
                            <span class="text-gray-600 dark:text-gray-400">Not Answered</span>
                        </div>
                    </div>
                    
                    <!-- Keyboard Shortcuts -->
                    <div class="mt-4 pt-4 border-t border-gray-200 dark:border-slate-700">
                        <p class="text-xs font-bold text-gray-900 dark:text-white mb-2">Keyboard Shortcuts</p>
                        <div class="space-y-1 text-xs text-gray-600 dark:text-gray-400">
                            <div class="flex justify-between">
                                <span>Next:</span>
                                <kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded border border-gray-300 dark:border-slate-600 font-semibold">N</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span>Previous:</span>
                                <kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded border border-gray-300 dark:border-slate-600 font-semibold">P</kbd>
                            </div>
                            <div class="flex justify-between">
                                <span>Options:</span>
                                <div class="flex gap-1">
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded border border-gray-300 dark:border-slate-600 font-semibold">A</kbd>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded border border-gray-300 dark:border-slate-600 font-semibold">B</kbd>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded border border-gray-300 dark:border-slate-600 font-semibold">C</kbd>
                                    <kbd class="px-2 py-1 bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 rounded border border-gray-300 dark:border-slate-600 font-semibold">D</kbd>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Mobile Question Navigator -->
    <button id="mobile-nav-toggle" class="lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-blue-600 text-white rounded-full shadow-2xl flex items-center justify-center z-50">
        <span class="material-symbols-outlined">grid_view</span>
    </button>
    
    <div id="mobile-nav-modal" class="lg:hidden fixed inset-0 bg-black/50 z-50 hidden">
        <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-slate-800 rounded-t-3xl max-h-[70vh] overflow-hidden transition-colors">
            <div class="p-4 border-b border-gray-200 dark:border-slate-700 flex items-center justify-between">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">Question Navigator</h3>
                <button id="close-mobile-nav" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[calc(70vh-80px)]">
                <div id="mobile-question-navigation" class="grid grid-cols-5 gap-2"></div>
            </div>
        </div>
    </div>
    
    <script>
        var examDurationSeconds = {{ (exam.duration.seconds if exam.duration else 0) }};
        var examData = {
            id: "{{ exam.id }}",
            subject: "{{ exam.subject.subject_name }}",
            examType: "{{ exam.exam_type }}"
        };
    </script>
    
    <script src="{{ url_for('static', filename='js/student/test_with_session.js') }}"></script>
</body>
</html>
