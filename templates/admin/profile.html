{% extends 'admin/base.html' %} {% block title %}Admin Profile{% endblock %} {% block content %}
<section class="mb-6 md:mb-8">
    <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4"
    >
        <div>
            <h1
                class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-2"
            >
                My Profile
            </h1>
            <p class="text-gray-600 dark:text-gray-400 text-sm md:text-base">
                Update your personal information and account settings.
            </p>
        </div>
        <div class="flex items-center gap-3">
            <button
                id="saveProfileBtn"
                class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-primary to-blue-600 text-white rounded-lg shadow-md hover:shadow-lg transition-all duration-200 text-sm"
            >
                <span class="material-symbols-outlined">save</span>
                <span>Save Profile</span>
            </button>
        </div>
    </div>
</section>

<div
    class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 overflow-hidden p-6"
>
    <div class="flex flex-col md:flex-row gap-6">
        <!-- Avatar column -->
        <div class="w-full md:w-1/3 flex flex-col items-center">
            <div
                class="w-36 h-36 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-700 flex items-center justify-center"
            >
                <img
                    id="avatarPreview"
                    src="{{ current_user.image if current_user and current_user.image else url_for('static', filename='images/default-avatar.png') }}"
                    alt="Admin Avatar"
                    class="w-full h-full object-cover"
                />
            </div>

            <label class="mt-4 text-xs text-gray-500 dark:text-gray-400"
                >Avatar URL</label
            >
            <input
                id="imageInput"
                type="text"
                placeholder="Image URL"
                value="{{ current_user.image if current_user and current_user.image else '' }}"
                class="mt-2 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none text-sm"
            />
        </div>

        <!-- Form column -->
        <div class="w-full md:w-2/3">
            <form
                id="adminProfileForm"
                class="space-y-4"
                onsubmit="return false;"
            >
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="firstName"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >First name</label
                        >
                        <input
                            id="firstName"
                            name="first_name"
                            type="text"
                            value="{{ current_user.first_name if current_user else '' }}"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        />
                    </div>

                    <div>
                        <label
                            for="lastName"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >Last name</label
                        >
                        <input
                            id="lastName"
                            name="last_name"
                            type="text"
                            value="{{ current_user.last_name if current_user else '' }}"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        />
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="email"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >Email</label
                        >
                        <input
                            id="email"
                            name="email"
                            type="email"
                            value="{{ current_user.email if current_user else '' }}"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        />
                    </div>

                    <div>
                        <label
                            for="gender"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >Gender</label
                        >
                        <select
                            id="gender"
                            name="gender"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        >
                            <option
                                value="Not specified"
                                {% if current_user and (current_user.gender == None or current_user.gender == '' or current_user.gender == 'Not specified') %}selected{% endif %}
                            >
                                Prefer not to say
                            </option>
                            <option
                                value="Male"
                                {% if current_user and current_user.gender == 'Male' %}selected{% endif %}
                            >
                                Male
                            </option>
                            <option
                                value="Female"
                                {% if current_user and current_user.gender == 'Female' %}selected{% endif %}
                            >
                                Female
                            </option>
                            <option
                                value="Other"
                                {% if current_user and current_user.gender == 'Other' %}selected{% endif %}
                            >
                                Other
                            </option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="dob"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >Date of birth</label
                        >
                        <input
                            id="dob"
                            name="dob"
                            type="date"
                            value="{{ current_user.dob.strftime('%Y-%m-%d') if current_user and current_user.dob else '' }}"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        />
                    </div>

                    <div>
                        <label
                            for="username"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >Username</label
                        >
                        <input
                            id="username"
                            name="username"
                            type="text"
                            value="{{ current_user.username if current_user else '' }}"
                            readonly
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-500 dark:text-gray-400 cursor-not-allowed"
                        />
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="password"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >New password</label
                        >
                        <input
                            id="password"
                            name="password"
                            type="password"
                            placeholder="Leave blank to keep current"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        />
                    </div>

                    <div>
                        <label
                            for="confirmPassword"
                            class="text-sm font-medium text-gray-700 dark:text-gray-300"
                            >Confirm password</label
                        >
                        <input
                            id="confirmPassword"
                            type="password"
                            placeholder="Confirm new password"
                            class="mt-1 w-full px-3 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none"
                        />
                    </div>
                </div>

                <div class="flex items-center gap-3 pt-4">
                    <button
                        id="submitBtn"
                        type="button"
                        class="px-4 py-2 bg-gradient-to-r from-primary to-blue-600 text-white rounded-xl shadow hover:shadow-lg transition"
                    >
                        Update Profile
                    </button>
                    <button
                        id="cancelBtn"
                        type="button"
                        class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-xl transition hover:bg-gray-200"
                    >
                        Reset
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const avatarPreview = document.getElementById("avatarPreview");
        const imageInput = document.getElementById("imageInput");
        const submitBtn = document.getElementById("submitBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const saveProfileBtn = document.getElementById("saveProfileBtn");

        function showNotification(message, type = "info") {
            const notification = document.createElement("div");
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${
                type === "success"
                    ? "bg-green-500 text-white"
                    : type === "error"
                      ? "bg-red-500 text-white"
                      : "bg-blue-500 text-white"
            }`;
            notification.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="material-symbols-outlined text-sm">${type === "success" ? "check_circle" : type === "error" ? "error" : "info"}</span>
        <span>${message}</span>
      </div>
    `;
            document.body.appendChild(notification);

            // animate in
            notification.style.transform = "translateX(20px)";
            setTimeout(() => {
                notification.style.transform = "translateX(0)";
            }, 10);

            // remove after 3s
            setTimeout(() => {
                notification.style.transform = "translateX(400px)";
                setTimeout(() => {
                    if (notification.parentNode)
                        notification.parentNode.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Update avatar preview when image URL input changes
        if (imageInput) {
            imageInput.addEventListener("input", function () {
                const url = imageInput.value.trim();
                if (!url) {
                    avatarPreview.src =
                        "{{ url_for('static', filename='images/default-avatar.png') }}";
                    return;
                }
                avatarPreview.src = url;
            });
        }

        function getFormData() {
            return {
                first_name:
                    (document.getElementById("firstName") &&
                        document.getElementById("firstName").value.trim()) ||
                    "",
                last_name:
                    (document.getElementById("lastName") &&
                        document.getElementById("lastName").value.trim()) ||
                    "",
                email:
                    (document.getElementById("email") &&
                        document.getElementById("email").value.trim()) ||
                    "",
                gender:
                    (document.getElementById("gender") &&
                        document.getElementById("gender").value) ||
                    null,
                dob:
                    (document.getElementById("dob") &&
                        document.getElementById("dob").value) ||
                    null,
                image:
                    (document.getElementById("imageInput") &&
                        document.getElementById("imageInput").value.trim()) ||
                    null,
                password:
                    (document.getElementById("password") &&
                        document.getElementById("password").value) ||
                    null,
                confirmPassword:
                    (document.getElementById("confirmPassword") &&
                        document.getElementById("confirmPassword").value) ||
                    null,
            };
        }

        async function submitProfile() {
            const data = getFormData();

            // Basic validation
            if (!data.first_name || !data.last_name) {
                showNotification(
                    "Please fill in your first and last name",
                    "error",
                );
                return;
            }
            if (data.password && data.password !== data.confirmPassword) {
                showNotification("Passwords do not match", "error");
                return;
            }

            // Build payload (omit confirmPassword)
            const payload = {
                first_name: data.first_name,
                last_name: data.last_name,
                email: data.email,
                gender: data.gender,
                dob: data.dob,
                image: data.image,
            };
            if (data.password) payload.password = data.password;

            submitBtn.disabled = true;
            submitBtn.textContent = "Updating...";

            try {
                const resp = await fetch("/admin/profile", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });

                const result = await resp.json().catch(() => null);

                if (resp.ok && result && result.success) {
                    showNotification(
                        result.message || "Profile updated",
                        "success",
                    );

                    // Update sidebar display if present
                    if (result.user) {
                        const nameEl =
                            document.querySelector(
                                "#adminCard .sidebar-text p",
                            ) ||
                            document.querySelector(
                                "#adminCard p.text-gray-800",
                            );
                        if (
                            nameEl &&
                            result.user.first_name &&
                            result.user.last_name
                        ) {
                            nameEl.textContent = `${result.user.first_name} ${result.user.last_name}`;
                        }
                        const adminAvatar =
                            document.getElementById("adminAvatar");
                        if (adminAvatar && result.user.image) {
                            adminAvatar.src = result.user.image;
                        }
                    }
                } else {
                    const message =
                        (result && (result.message || result.error)) ||
                        "Failed to update profile";
                    showNotification(message, "error");
                }
            } catch (err) {
                console.error("Profile update error:", err);
                showNotification(
                    "Network error while updating profile",
                    "error",
                );
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = "Update Profile";
            }
        }

        if (submitBtn) submitBtn.addEventListener("click", submitProfile);
        if (saveProfileBtn)
            saveProfileBtn.addEventListener("click", submitProfile);
        if (cancelBtn)
            cancelBtn.addEventListener("click", function () {
                window.location.reload();
            });
    });
</script>
{% endblock %}
